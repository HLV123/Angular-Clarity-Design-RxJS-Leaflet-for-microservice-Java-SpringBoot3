<div class="page-header">
  <div>
    <h2>Quản lý Thiết bị IoT</h2>
    <p>Module 9 · MQTT/HTTP Gateway · Kafka Pipeline · WebSocket /topic/devices/status</p>
  </div>
</div>

<div class="stats-grid">
  <div class="stat-card" style="border-top:3px solid #10b981"><i class="fa-solid fa-wifi stat-bg-icon" style="color:#10b981"></i><div class="stat-label">Online</div><div class="stat-value" style="color:#10b981">{{ onlineCount() }}</div></div>
  <div class="stat-card" style="border-top:3px solid #ef4444"><i class="fa-solid fa-plug-circle-xmark stat-bg-icon" style="color:#ef4444"></i><div class="stat-label">Offline</div><div class="stat-value" style="color:#ef4444">{{ offlineCount() }}</div></div>
  <div class="stat-card" style="border-top:3px solid #f59e0b"><i class="fa-solid fa-triangle-exclamation stat-bg-icon" style="color:#f59e0b"></i><div class="stat-label">Warning / Error</div><div class="stat-value" style="color:#f59e0b">{{ warningCount() }}</div></div>
  <div class="stat-card" style="border-top:3px solid #8b5cf6"><i class="fa-solid fa-battery-quarter stat-bg-icon" style="color:#8b5cf6"></i><div class="stat-label">Pin yếu (&lt;20%)</div><div class="stat-value" style="color:#8b5cf6">{{ lowBatteryCount() }}</div></div>
</div>

<div class="filter-bar">
  <input type="text" placeholder="Tìm theo ID, model, bệnh nhân, phòng..." [ngModel]="searchTerm()" (ngModelChange)="searchTerm.set($event)">
  <select [ngModel]="filterStatus()" (ngModelChange)="filterStatus.set($event)">
    <option value="ALL">Tất cả trạng thái</option>
    <option value="ONLINE">Online</option><option value="OFFLINE">Offline</option>
    <option value="WARNING">Warning</option><option value="ERROR">Error</option>
  </select>
  <select [ngModel]="filterType()" (ngModelChange)="filterType.set($event)">
    <option value="ALL">Tất cả loại</option>
    @for (t of deviceTypes(); track t) { <option [value]="t">{{ t }}</option> }
  </select>
</div>

<div class="card">
  <div style="overflow-x:auto">
    <table>
      <thead>
        <tr><th>Device ID</th><th>Loại</th><th>Model</th><th>Bệnh nhân</th><th>Phòng</th><th>Trạng thái</th><th>Pin</th><th>Chất lượng DL</th><th>Đồng bộ cuối</th><th>Hành động</th></tr>
      </thead>
      <tbody>
        @for (d of filteredDevices(); track d.id) {
          <tr>
            <td><span style="font-family:monospace;font-weight:600;color:#1574ea;font-size:12px">{{ d.id }}</span></td>
            <td>{{ d.type }}</td>
            <td style="font-size:12px">{{ d.model }}</td>
            <td>
              @if (d.assignedPatientName) { <strong>{{ d.assignedPatientName }}</strong> }
              @else { <span style="color:#94a3b8">— Chưa gán</span> }
            </td>
            <td>{{ d.ward }}</td>
            <td>
              <span class="badge" [class]="getStatusClass(d.status)">
                <i class="fa-solid" [class]="getStatusIcon(d.status)"></i> {{ d.status }}
              </span>
            </td>
            <td>
              <span [style.color]="getBatteryColor(d.batteryLevel)">
                <i class="fa-solid" [class]="getBatteryIcon(d.batteryLevel)"></i>
                {{ d.batteryLevel }}%
              </span>
            </td>
            <td>
              <div style="display:flex;align-items:center;gap:6px">
                <div style="width:50px;height:5px;background:#e2e8f0;border-radius:10px;overflow:hidden">
                  <div [style.width.%]="d.dataQuality" [style.background]="getQualityColor(d.dataQuality)" style="height:100%;border-radius:10px"></div>
                </div>
                <span style="font-size:12px">{{ d.dataQuality }}%</span>
              </div>
            </td>
            <td style="font-size:11px;color:#64748b;white-space:nowrap">{{ d.lastSyncAt | date:'dd/MM HH:mm' }}</td>
            <td>
              <div style="display:flex;gap:4px">
                <button class="btn-icon" title="Chi tiết" (click)="openDetail(d)"><i class="fa-solid fa-eye"></i></button>
                <button class="btn-icon" title="Gán bệnh nhân" (click)="openAssign(d)"><i class="fa-solid fa-link"></i></button>
                <button class="btn-icon" title="Hiệu chỉnh" (click)="requestCalibration(d)"><i class="fa-solid fa-wrench"></i></button>
              </div>
            </td>
          </tr>
        } @empty {
          <tr><td colspan="10" style="text-align:center;padding:40px;color:#94a3b8">Không tìm thấy thiết bị</td></tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Detail Modal -->
@if (showDetailModal() && selectedDevice(); as d) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header"><h3>Chi tiết thiết bị {{ d.id }}</h3><button (click)="closeModals()">✕</button></div>
      <div class="modal-body">
        <div class="detail-grid">
          <div class="detail-item"><span class="detail-label">Device ID</span><span class="detail-value">{{ d.id }}</span></div>
          <div class="detail-item"><span class="detail-label">Loại thiết bị</span><span class="detail-value">{{ d.type }}</span></div>
          <div class="detail-item"><span class="detail-label">Model</span><span class="detail-value">{{ d.model }}</span></div>
          <div class="detail-item"><span class="detail-label">Firmware</span><span class="detail-value">{{ d.firmwareVersion }}</span></div>
          <div class="detail-item"><span class="detail-label">Phòng / Giường</span><span class="detail-value">{{ d.ward }}</span></div>
          <div class="detail-item"><span class="detail-label">Trạng thái</span><span class="badge" [class]="getStatusClass(d.status)">{{ d.status }}</span></div>
          <div class="detail-item"><span class="detail-label">Pin</span><span [style.color]="getBatteryColor(d.batteryLevel)"><i class="fa-solid" [class]="getBatteryIcon(d.batteryLevel)"></i> {{ d.batteryLevel }}%</span></div>
          <div class="detail-item"><span class="detail-label">Chất lượng dữ liệu</span><span [style.color]="getQualityColor(d.dataQuality)">{{ d.dataQuality }}%</span></div>
          <div class="detail-item"><span class="detail-label">Bệnh nhân</span><span class="detail-value">{{ d.assignedPatientName || 'Chưa gán' }}</span></div>
          <div class="detail-item"><span class="detail-label">Đồng bộ cuối</span><span class="detail-value">{{ d.lastSyncAt | date:'dd/MM/yyyy HH:mm:ss' }}</span></div>
        </div>
      </div>
    </div>
  </div>
}

<!-- Assign Modal -->
@if (showAssignModal() && selectedDevice(); as d) {
  <div class="modal-overlay" (click)="closeModals()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header"><h3>Gán thiết bị {{ d.id }}</h3><button (click)="closeModals()">✕</button></div>
      <div class="modal-body">
        <div class="form-group">
          <label>Chọn bệnh nhân</label>
          <select [ngModel]="assignPatientId()" (ngModelChange)="assignPatientId.set($event)">
            <option value="">-- Bỏ gán (không gán ai) --</option>
            @for (p of patients; track p.id) {
              <option [value]="p.id">{{ p.id }} · {{ p.fullName }} ({{ p.ward }})</option>
            }
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeModals()">Hủy</button>
        <button class="btn btn-primary" (click)="saveAssign()"><i class="fa-solid fa-link"></i> Lưu</button>
      </div>
    </div>
  </div>
}
