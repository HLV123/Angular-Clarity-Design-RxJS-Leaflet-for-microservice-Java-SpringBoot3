<div class="page-header">
  <div>
    <h2>Quản lý Người dùng (IAM)</h2>
    <p>Module 11 · Keycloak / Spring Security · RBAC Authentication & Authorization</p>
  </div>
  <button class="btn btn-primary" (click)="openCreateModal()">
    <i class="fa-solid fa-user-plus"></i> Thêm người dùng
  </button>
</div>

<div class="card" style="margin-top:16px;min-height:calc(100vh - 200px)">
  <div class="card-header" style="justify-content:space-between">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="search-box">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input type="text" placeholder="Tìm theo tên, email, username..." [ngModel]="searchTerm()"
          (ngModelChange)="searchTerm.set($event)">
      </div>
      <select class="form-select" [ngModel]="filterRole()" (ngModelChange)="filterRole.set($event)"
        style="width:160px;font-size:13px">
        <option value="ALL">Tất cả vai trò</option>
        <option value="ADMIN">ADMIN</option>
        <option value="DOCTOR">DOCTOR</option>
        <option value="NURSE">NURSE</option>
        <option value="PHARMACIST">PHARMACIST</option>
        <option value="PATIENT">PATIENT</option>
      </select>
      <select class="form-select" [ngModel]="filterStatus()" (ngModelChange)="filterStatus.set($event)"
        style="width:160px;font-size:13px">
        <option value="ALL">Tất cả trạng thái</option>
        <option value="ACTIVE">Hoạt động (ACTIVE)</option>
        <option value="INACTIVE">Ngừng hoạt động</option>
        <option value="LOCKED">Đã khóa (LOCKED)</option>
      </select>
    </div>
    <span class="badge badge-normal">{{ filteredUsers().length }} users</span>
  </div>

  <div class="table-responsive">
    <table>
      <thead>
        <tr>
          <th>Người dùng</th>
          <th>Vai trò (Roles)</th>
          <th>Phòng ban</th>
          <th>Trạng thái</th>
          <th>Đăng nhập lần cuối</th>
          <th>Bảo mật MFA</th>
          <th style="text-align:right">Hành động</th>
        </tr>
      </thead>
      <tbody>
        @for (u of filteredUsers(); track u.id) {
        <tr>
          <td>
            <div style="display:flex;align-items:center;gap:12px">
              <div class="avatar-circle">
                @if (u.avatar) {
                <img [src]="u.avatar" alt="avatar">
                } @else {
                {{ u.fullName.charAt(0) }}
                }
              </div>
              <div>
                <strong style="color:#0f172a;display:block;margin-bottom:2px">{{ u.fullName }}</strong>
                <span style="font-size:11px;color:#64748b;font-family:monospace">{{ u.username }} · {{ u.email }}</span>
              </div>
            </div>
          </td>
          <td>
            <div style="display:flex;gap:4px;flex-wrap:wrap">
              @for (r of u.roles; track r) {
              <span class="badge" [class]="getRoleBadgeClass(r)">{{ r }}</span>
              }
            </div>
          </td>
          <td>{{ u.department || '-' }}</td>
          <td><span class="badge" [class]="getStatusBadgeClass(u.status)">{{ u.status }}</span></td>
          <td>
            @if (u.lastLogin) {
            {{ u.lastLogin | date:'dd/MM/yyyy HH:mm' }}
            } @else {
            <span style="color:#94a3b8">-</span>
            }
          </td>
          <td>
            @if (u.mfaEnabled) {
            <span style="color:#10b981;font-size:12px"><i class="fa-solid fa-shield-halved"></i> 2FA On</span>
            } @else {
            <span style="color:#94a3b8;font-size:12px"><i class="fa-solid fa-shield"></i> 2FA Off</span>
            }
          </td>
          <td style="text-align:right">
            <button class="btn-icon" title="Sửa" (click)="openEditModal(u)"><i class="fa-solid fa-pen"></i></button>
            <button class="btn-icon" [title]="u.status === 'LOCKED' ? 'Mở khóa' : 'Khóa'" (click)="toggleLock(u)">
              <i class="fa-solid" [class.fa-lock]="u.status !== 'LOCKED'" [class.fa-unlock]="u.status === 'LOCKED'"
                [style.color]="u.status === 'LOCKED' ? '#10b981' : '#f59e0b'"></i>
            </button>
            <button class="btn-icon danger" title="Xóa" (click)="deleteUser(u.id)"><i
                class="fa-solid fa-trash"></i></button>
          </td>
        </tr>
        }
        @if (filteredUsers().length === 0) {
        <tr>
          <td colspan="7" style="text-align:center;padding:32px;color:#94a3b8">Không tìm thấy người dùng</td>
        </tr>
        }
      </tbody>
    </table>
  </div>
</div>

<!-- Modal Create / Edit User -->
@if (showModal()) {
<div class="modal-overlay" (click)="closeModal()">
  <div class="modal-content" style="max-width:640px" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ isEditing() ? 'Cập nhật tài khoản: ' + currentUser.username : 'Tạo mới Người dùng' }}</h3>
      <button class="btn btn-secondary" (click)="closeModal()" style="padding:6px;border:none"><i
          class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
        <div class="form-group">
          <label>Tên đăng nhập (Username) *</label>
          <input type="text" class="form-control" [(ngModel)]="currentUser.username" [disabled]="isEditing()"
            placeholder="e.g. jdoe">
        </div>
        <div class="form-group">
          <label>Họ và Tên (Full Name) *</label>
          <input type="text" class="form-control" [(ngModel)]="currentUser.fullName" placeholder="Nguyễn Văn A">
        </div>
        <div class="form-group">
          <label>Email *</label>
          <input type="email" class="form-control" [(ngModel)]="currentUser.email" placeholder="email@example.com">
        </div>
        <div class="form-group">
          <label>Số điện thoại</label>
          <input type="text" class="form-control" [(ngModel)]="currentUser.phone" placeholder="090...">
        </div>
        <div class="form-group">
          <label>Phòng ban (Department)</label>
          <select class="form-select" [(ngModel)]="currentUser.department">
            <option value="Ban Giám Đốc">Ban Giám Đốc</option>
            <option value="Khoa Nội">Khoa Nội</option>
            <option value="Khoa Ngoại">Khoa Ngoại</option>
            <option value="Hồi sức cấp cứu">Hồi sức cấp cứu (ICU)</option>
            <option value="Khoa Nhi">Khoa Nhi</option>
            <option value="IT">Công Nghệ Thông Tin</option>
          </select>
        </div>
        <div class="form-group">
          <label>Trạng thái</label>
          <select class="form-select" [(ngModel)]="currentUser.status">
            <option value="ACTIVE">ACTIVE</option>
            <option value="INACTIVE">INACTIVE</option>
            <option value="LOCKED">LOCKED</option>
          </select>
        </div>
      </div>

      <div class="form-group" style="margin-bottom:24px">
        <label>Vai trò (Roles)</label>
        <div style="font-size:12px;color:#64748b;margin-bottom:8px">Cách nhau bởi dấu phẩy (VD: DOCTOR, ADMIN)</div>
        <input type="text" class="form-control" [ngModel]="currentUser.roles?.join(', ')"
          (ngModelChange)="updateRoles($event)">
      </div>

    </div>
    <div class="modal-footer"
      style="padding:16px 24px;border-top:1px solid #f1f5f9;display:flex;justify-content:flex-end;gap:12px">
      <button class="btn btn-secondary" (click)="closeModal()">Thoát</button>
      <button class="btn btn-primary" (click)="saveUser()"><i class="fa-solid fa-cloud-arrow-up"
          style="margin-right:6px"></i> {{ isEditing() ? 'Lưu cập nhật' : 'Tạo tài khoản' }}</button>
    </div>
  </div>
</div>
}