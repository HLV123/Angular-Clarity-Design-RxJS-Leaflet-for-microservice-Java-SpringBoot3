<header class="header">
  <div class="header-left">
    <button class="toggle-btn" (click)="toggleSidebar.emit()">
      <i class="fa-solid fa-bars"></i>
    </button>
    <div class="search-wrapper">
      <i class="fa-solid fa-magnifying-glass search-icon"></i>
      <input type="text" class="search-input" placeholder="Tìm bệnh nhân, thuốc, ICD-10..."
        [(ngModel)]="searchQuery" (input)="onSearch()" (blur)="hideSearch()">
      @if (showSearch()) {
        <div class="search-dropdown">
          @for (r of searchResults(); track r.id) {
            <div class="search-item">
              <span class="search-type" [class]="'type-' + r.type">{{ r.type }}</span>
              <div class="search-info">
                <div class="search-title">{{ r.title }}</div>
                <div class="search-sub">{{ r.subtitle }}</div>
              </div>
            </div>
          } @empty {
            <div class="search-empty">Không tìm thấy kết quả</div>
          }
        </div>
      }
    </div>
  </div>

  <div class="header-right">
    <!-- WebSocket Status -->
    <div class="ws-status" [class.connected]="wsConnected()">
      <span class="ws-dot"></span>
      <span>{{ wsConnected() ? 'STOMP Live' : 'Disconnected' }}</span>
    </div>

    <!-- Notifications -->
    <div class="notif-wrapper">
      <button class="header-icon-btn" (click)="toggleNotif()">
        <i class="fa-solid fa-bell"></i>
        @if (unreadCount() > 0) { <span class="notif-badge">{{ unreadCount() }}</span> }
      </button>
      @if (showNotif()) {
        <div class="notif-dropdown">
          <div class="notif-header">
            <strong>Thông báo</strong>
            <button class="mark-read" (click)="markAllRead()">Đã đọc tất cả</button>
          </div>
          @for (a of alerts; track a.id) {
            <div class="notif-item">
              <span class="badge" [class]="getLevelClass(a.level)">{{ a.level }}</span>
              <div class="notif-content">
                <div class="notif-msg">{{ a.message }}</div>
                <div class="notif-time">{{ a.timestamp | date:'HH:mm dd/MM' }}</div>
              </div>
            </div>
          }
        </div>
      }
    </div>

    <!-- User menu -->
    <div class="user-menu-wrapper">
      <button class="user-menu-btn" (click)="toggleUserMenu()">
        <div class="user-menu-avatar">{{ getUserInitials() }}</div>
        <span class="user-menu-name">{{ getUserName() }}</span>
        <i class="fa-solid fa-chevron-down" style="font-size:10px;color:#94a3b8"></i>
      </button>
      @if (showUserMenu()) {
        <div class="user-dropdown">
          <div class="user-dropdown-header">
            <div class="user-dropdown-avatar">{{ getUserInitials() }}</div>
            <div>
              <div class="user-dropdown-name">{{ getUserName() }}</div>
              <div class="user-dropdown-role">{{ getUserRole() }}</div>
            </div>
          </div>
          <div class="user-dropdown-divider"></div>
          <button class="user-dropdown-item" (click)="logout()">
            <i class="fa-solid fa-right-from-bracket"></i> Đăng xuất
          </button>
        </div>
      }
    </div>
  </div>
</header>
